# Bilibili视频及评论采集工具

## 项目简介

这是一个基于Python的B站视频信息与评论采集工具，可以根据关键词搜索相关视频、获取视频详情信息以及爬取视频评论。采用异步IO技术大幅提升评论爬取效率，支持视频基本信息和评论数据的导出，采用随机Cookie生成技术避免被反爬封禁。

## 功能特性

- **视频信息采集**
  - 支持关键词搜索视频
  - 支持多个关键词的AND/OR逻辑组合查询
  - 支持按时间范围筛选视频
  - 支持视频标题黑名单过滤
  - 自动获取视频详情页信息(播放量、点赞数等)

- **反爬与优化**
  - 自动生成随机Cookie和请求头
  - 随机延时请求避免触发频率限制
  - 自动处理请求失败和重试机制
  - **分批次处理请求，控制并发数量**
  - **优化的资源管理，防止请求过载**
  - 进度条显示采集状态

- **数据导出**
  - 视频信息导出为Excel格式
  - 评论数据导出为CSV格式（支持UTF-8编码）

## 环境要求

```
Python 3.7+
pandas
aiohttp
requests
beautifulsoup4
tqdm
```

## 使用方法

### 1. 视频信息采集

1. 配置搜索参数（config.py）:
```python
config = {
    "keywords": ["关键词1", "关键词2"],  # 支持多关键词
    "keywords_blacklist": [],  # 标题黑名单
    "is_union": True,  # True为OR逻辑，False为AND逻辑
    "file_path": "./bilibili_search.xlsx",  # 输出文件路径
    "page": 1,  # 每个关键词搜索的页数
    "time_begin": None,  # 起始时间，格式："2024-01-01 00:00:00"
    "time_end": None,  # 结束时间，格式同上
}
```

2. 运行主程序：
```bash
python main.py
```

### 2. 评论数据采集

配置`bil_comment_crawl.py`中的参数：
```python
# 获取视频bv
bv = "BV1GeUUYREXy"
# 获取视频oid和标题
aid = '113520163229242'
title = '《崩坏：星穹铁道》黄金史诗PV：「翁法罗斯英雄纪」'
# 是否开启二级评论爬取
is_second = True  # 设为True启用二级评论爬取
# 最大爬取页数
max_page = 5  # 控制爬取的评论页数
```

运行评论采集程序：
```bash
python bil_comment_crawl.py
```

## 项目结构

```
├── main.py                # 主程序入口(视频搜索)
├── config.py              # 配置文件
├── bilibili_api.py        # B站API接口封装
├── bil_search_page.py     # 搜索页面解析
├── bil_comment_crawl.py   # 评论采集模块(异步实现)
├── random_bil_cookie.py   # Cookie生成工具
└── test_effiency.ipynb    # 效率测试模块
```

## 功能说明

### 视频信息采集

从B站搜索页面获取视频列表，然后访问每个视频的详情页获取完整的视频信息，包括：
- 视频标题、BV号、AV号
- 视频发布时间、播放量、弹幕数
- 点赞数、收藏数、分享数、硬币数
- UP主信息、视频简介
- 视频分区、标签

### 评论采集

通过B站评论API异步获取视频下的评论数据，包括：
- 评论内容、评论ID、上级评论ID(回复关系)
- 用户信息(ID、用户名、等级、性别)
- 评论时间、点赞数、回复数
- 用户头像、个性签名、IP属地
- 用户大会员状态


### 数据清洗

- 处理HTML标签和转义字符
- 去重处理重复数据
- 规范化时间格式
- 处理异常字段和缺失值


## 开发计划

1. **评论区数据分析**
   - 支持评论内容情感分析
   - 用户画像生成
   - 热门评论话题提取

2. **数据存储优化**
   - 将数据存储迁移至SQL数据库
   - 设计合理的数据库结构
   - 实现增量更新机制

3. **采集能力扩展**
   - 添加用户关注关系采集
   - 支持弹幕内容获取
   - 添加视频下载功能

## 已知问题

- B站限制了搜索结果最大页数(约34页)
- 某些情况下评论API会返回错误数据，导致迭代提前终止

## 免责声明

本工具仅用于学习研究，请勿用于商业用途。使用本工具时请遵守B站相关规定和服务条款，不要进行高频次、大规模的数据采集。对因使用本工具造成的任何直接或间接损失，作者不承担任何责任。

## 许可证

[MIT License](https://opensource.org/licenses/MIT)